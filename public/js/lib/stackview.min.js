"use strict";function annotatorMaker(n){function e(n){return!$.isArray(n)||n.length<1?(console.error("No valid annotations to load"),!1):(h=n,o(),void 0)}function t(n,e,t){function o(){var o={image:n,type:e,coords:t};h.push(o)}$.isFunction(g.beforeAddAnnotation)?g.beforeAddAnnotation(o):o()}function o(n,e){var t=h.filter(function(e){return e.image===n});t.forEach(function(n){switch(n.type){case"point":u(l(n.coords,e));break;case"arrow":d(l(n.coords.from,e),l(n.coords.to,e))}})}function r(){return h}function i(){h=[]}function a(n){h=h.filter(function(e){return e.image!==n})}function c(e,t){e=e.map(function(n){return n-.5}),t=t.map(function(n){return n-.5}),n.lineWidth=f.lineWidth,n.beginPath(),n.strokeStyle=f.primaryStrokeStyle,n.moveTo(e[0],e[1]),n.lineTo(t[0],t[1]),n.stroke(),n.beginPath(),n.strokeStyle=f.secondaryStrokeStyle,n.moveTo(e[0]+1,e[1]+1),n.lineTo(t[0]+1,t[1]+1),n.stroke()}function s(e,t,o){n.beginPath(),n.strokeStyle=f.primaryStrokeStyle,n.arc(e,t,o,0,2*Math.PI,!0),n.stroke(),n.closePath(),n.beginPath(),n.strokeStyle=f.secondaryStrokeStyle,n.arc(e,t,o-1,0,2*Math.PI,!0),n.stroke(),n.closePath()}function u(n){var e=n[0],t=n[1];c([e-5,t],[e+5,t]),c([e,t-5],[e,t+5]),s(e,t,20)}function d(e,t){function o(n,e,t,o){n.save(),n.beginPath(),n.translate(e,t),n.rotate(o),c([0,0],[10,20]),c([-1,0],[-10,20]),n.restore()}var r=e[0],i=e[1],a=t[0],s=t[1];c(e,t);var u=Math.atan((s-i)/(a-r));u+=(a>=r?90:-90)*Math.PI/180,o(n,a,s,u)}function l(n,e){var t=n[0]*e,o=n[1]*e;return[t,o]}var f={primaryStrokeStyle:"white",secondaryStrokeStyle:"black",lineWidth:"1"},h=[],g={beforeAddAnnotation:function(n){n()}};return{addAnnotation:t,draw:o,getAnnotations:r,clearAllAnnotations:i,clearAnnotations:a,markArrow:d,markPoint:u,loadAnnotations:e,hooks:g}}!function(n){function e(){n(".dropdown-backdrop").remove(),n(o).each(function(){t(n(this)).removeClass("open")})}function t(e){var t,o=e.attr("data-target");return o||(o=e.attr("href"),o=o&&/#/.test(o)&&o.replace(/.*(?=#[^\s]*$)/,"")),t=o&&n(o),t&&t.length||(t=e.parent()),t}var o="[data-toggle=dropdown]",r=function(e){var t=n(e).on("click.dropdown.data-api",this.toggle);n("html").on("click.dropdown.data-api",function(){t.parent().removeClass("open")})};r.prototype={constructor:r,toggle:function(){var o,r,i=n(this);if(!i.is(".disabled, :disabled"))return o=t(i),r=o.hasClass("open"),e(),r||("ontouchstart"in document.documentElement&&n('<div class="dropdown-backdrop"/>').insertBefore(n(this)).on("click",e),o.toggleClass("open")),i.focus(),!1},keydown:function(e){var r,i,a,c,s;if(/(38|40|27)/.test(e.keyCode)&&(r=n(this),e.preventDefault(),e.stopPropagation(),!r.is(".disabled, :disabled"))){if(a=t(r),c=a.hasClass("open"),!c||c&&27==e.keyCode)return 27==e.which&&a.find(o).focus(),r.click();i=n("[role=menu] li:not(.divider):visible a",a),i.length&&(s=i.index(i.filter(":focus")),38==e.keyCode&&s>0&&s--,40==e.keyCode&&s<i.length-1&&s++,~s||(s=0),i.eq(s).focus())}}};var i=n.fn.dropdown;n.fn.dropdown=function(e){return this.each(function(){var t=n(this),o=t.data("dropdown");o||t.data("dropdown",o=new r(this)),"string"==typeof e&&o[e].call(t)})},n.fn.dropdown.Constructor=r,n.fn.dropdown.noConflict=function(){return n.fn.dropdown=i,this},n(document).on("click.dropdown.data-api",e).on("click.dropdown.data-api",".dropdown form",function(n){n.stopPropagation()}).on("click.dropdown.data-api",o,r.prototype.toggle).on("keydown.dropdown.data-api",o+", [role=menu]",r.prototype.keydown)}(window.jQuery),function(n){n.fn.imagesLoaded=function(n){function e(){n.call(o,r)}function t(n){--i<=0&&n.target.src!==a&&(setTimeout(e),r.unbind("load error",t))}var o=this,r=o.find("img").add(o.filter("img")),i=r.length,a="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";return i||e(),r.bind("load error",t).each(function(){if(this.complete||"undefined"==typeof this.complete){var n=this.src;this.src=a,this.src=n}}),o}}(jQuery),function(n){n.fn.disableSelection=function(){return this.attr("unselectable","on").css("user-select","none").on("selectstart",!1)},n.fn.enableSelection=function(){return this.attr("unselectable","off").css("user-select","text").off("selectstart")},n(document).ready(function(){n(".viewer-controls li").click(function(n){n.stopPropagation()})})}(jQuery);var viewerMaker=function(){function n(n){return"undefined"==typeof _.folderPath||_.folderPath===!1?n:_.folderPath+n}function e(){$(document).off("."+_.ns),$(ee).off("."+_.ns),Z=!1}function t(n,e,t){var i=!1;"undefined"!=typeof t&&$.each(t,function(n,e){_[n]=e}),"undefined"!=typeof n&&(console.log("load new images"),ne=n,ne.finished=[],ne.errors=[],ne.length=ne.images.length),"undefined"!=typeof e&&(ee=e),oe=ee.offset().top,te=ee.offset().left,K.progBarH=ee.find(".progressBar").height(),re=ee.find("#canvas_container");var c="<canvas>Sorry, your browser does not support html5 canvas. Please consider upgrading to a modern browser:</canvas>";re.empty().append(c),Z=!0,J=re.find("canvas"),J.css({position:"absolute",top:"50%",left:"50%",marginLeft:"undefined"!=typeof K.margin?K.margin.left:-(J.width()/2),marginTop:"undefined"!=typeof K.margin?K.margin.top:-(J.height()/2)+ee.find(".progressBar").height()}),$.isFunction(annotatorMaker)&&(j=annotatorMaker(J.get(0).getContext("2d"))),$(document).on("mousemove."+_.ns,function(n){P(n,!1)}),$(document).on("touchmove."+_.ns,function(n){P(n,!0)}),$(document).on("mouseup."+_.ns,function(n){S(n)}),$(document).on("touchend."+_.ns,function(n){S(n,!0)}),$(window).on("resize",a),$(document).on("fitViewer",a),ee.on("mousedown."+_.ns,function(n){C(n,!1)}),ee.on("touchstart."+_.ns,function(n){C(n,!0)}),ee.on("click."+_.ns,function(n){I(n,!1)}),ee.on("DOMMouseScroll mousewheel",function(n){M(n)}),$("#"+_.ns+" .scrollByPos").prop("checked",_.scrollByPos?!0:!1),$("#"+_.ns+" "+_.controlsContainer).css({"z-index":"1"}),$(document).on("click."+_.ns,"#"+_.ns+" .playToggle",function(){T(this)}),$(document).on("click."+_.ns,"#"+_.ns+" .scrollControl",function(){l("scroll")}),$(document).on("click."+_.ns,"#"+_.ns+" .zoomControl",function(){l("zoom")}),$(document).on("click."+_.ns,"#"+_.ns+" .panControl",function(){l("pan")}),$(document).on("click."+_.ns,"#"+_.ns+" .actualSizeButton",function(){u()}),$(document).on("click."+_.ns,"#"+_.ns+" .fitButton",function(){s()}),$(document).on("click."+_.ns,"#"+_.ns+" .markPointControl",function(){l("markPoint")}),$(document).on("click."+_.ns,"#"+_.ns+" .markArrowControl",function(){l("markArrow")}),$(document).on("click."+_.ns,"#"+_.ns+" .removeAnnotationsControl",function(){V()}),$(document).on("change."+_.ns,"#"+_.ns+" .scrollByPos",function(){_.scrollByPos=this.checked,console.log(this.checked)}),$(document).on("click."+_.ns,"#"+_.ns+" .fullScreen",function(){var n=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement;n?r():o(ee)}),ee.on("fullscreenchange."+_.ns+" mozfullscreenchange."+_.ns+" webkitfullscreenchange."+_.ns,function(){console.log("fullscreen toggle"),s()}),document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||$("#"+_.ns+" .fullScreen").hide(),l(_.activeControl),1===R&&T(),"undefined"!=typeof n?(ne.paths=[],ne.currentImg=0,q(0,ne.length),i=w()):"undefined"!=typeof ne.currentImg?(z(ne.currentImg),q(ne.currentImg,ne.length)):(z(0),q(0,ne.length))}function o(n){var e=n.get(0);e.requestFullScreen?e.requestFullScreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen&&e.webkitRequestFullScreen(),s()}function r(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen(),s()}function i(){a(),s()}function a(){var n=ee.width(),e=ee.find(".progressBar");e.width(n),q(ne.currentImg,ne.length)}function c(){return"undefined"!=typeof ne.currentImg?ne.paths[ne.currentImg]:!1}function s(){var n=ee.find(".progressBar"),e=ee.width(),t=ee.height()-n.height(),o=c();if(o){var r=o.height/o.width,i=t/e,a=0,s=0;r>=i?(s=t,a=t/r):(a=e,s=e*r),d(a,s)}else d(e,t);K.width=J.width(),K.height=J.height(),h(),g(),O()}function u(){var n=ne.paths[ne.currentImg];d(n.width,n.height),h(K.pan),O()}function d(n,e){J.get(0).width=n,J.get(0).height=e,K.width=n,K.height=e,k()}function l(n){$("#"+_.ns+" .controlButton").removeClass("active"),$("#"+_.ns+" ."+n+"Control").addClass("active"),ce=n}function f(){return{x:J.offset().left-te+K.width/2,y:J.offset().top-oe+K.height/2}}function h(n,e){var t=0,o=0,r={};"object"==typeof n&&e?(t=n.x-U,o=n.y-W,K.margin.left+=t,K.margin.top+=o):"object"!=typeof n||e?K.margin={left:-K.width/2,top:-K.height/2}:(r=f(),t=K.pan.x-r.x,o=K.pan.y-r.y,K.margin.left+=t,K.margin.top+=o),J.css({marginLeft:K.margin.left,marginTop:K.margin.top}),K.pan=f()}function g(n){"undefined"==typeof n&&(n={width:K.width,height:K.height}),d(n.width,n.height),h(K.pan)}function p(n){return!n.complete||"undefined"!=typeof n.naturalWidth&&0===n.naturalWidth?!1:!0}function m(n){return""!==$(n).attr("src")&&"undefined"!=typeof $(n).attr("src")?!0:!1}function v(e,t){var o=ne.finished,r=ne.errors;if(o.push(e),ee.find(".loadProgress div").eq(e).addClass("image-loaded"),p(ne.paths[e])||(r.push(e),ee.find(".loadProgress div").eq(e).addClass("image-load-error"),console.error("Image "+e+" did not load correctly")),t){var i=function(e){$(ne.paths[e]).imagesLoaded(function(){v(e,!0)}),ne.paths[e].src=n(ne.images[e])},a=ne.paths[e+1];if(m(a)){if(-1!==o.indexOf(e+1)){var c=!1;$.each(ne.paths,function(n,e){return m(e)?void 0:(c=n,!1)}),c?i(c):ae=!0}console.error("This image should not be loaded yet")}else{if("undefined"==typeof ne.paths[e+1]&&e+1===ne.length)return console.log("Study finished loading"),ae=!0,void 0;i(e+1)}}}function w(){ie=!0;var e,t=ee.find(".loadProgress");for(e in ne.images)"number"!=typeof e&&(e=parseInt(e,"10")),ne.paths[e]=new Image,t.append(document.createElement("div"));return t.find("div").width(t.width()/ne.length),$(ne.paths[0]).imagesLoaded(function(){v(0,!0),z(0),s()}),ne.paths[0].src=n(ne.images[0]),!0}function y(e){$(ne.paths[e]).imagesLoaded(function(){v(e),z(e)}),ne.paths[e].src=n(ne.images[e])}function k(){var n=J.get(0).getContext("2d");"undefined"!=typeof ne.paths&&"undefined"!=typeof ne.currentImg&&n.drawImage(ne.paths[ne.currentImg],0,0,K.width,K.height)}function A(){var n=c(),e=K.height,t=n.height;return e/t}function b(n,e){var t,o;if(!n)return!1;e?(t=n.originalEvent.targetTouches[0].pageX,o=n.originalEvent.targetTouches[0].pageY):(t=n.pageX,o=n.pageY);var r=t-te,i=o-oe,a=K.height,c=K.width,s=A(),u=K.pan.x-c/2,d=K.pan.y-a/2,l=r-u,f=i-d,h=l/s,g=f/s,p={container:[r,i],canvas:[l,f],image:[h,g]};return p}function C(n,e){var t=ne.length,o=Math.round(512/t*100)/100,r=b(n,e);X=Y>=o?o:Y,Q=1,$("body").disableSelection(),U=r.container[0],W=r.container[1],$(H).trigger("action-start",[{mousepos:r}]),$.isFunction(se[ce].onMouseDown)&&se[ce].onMouseDown(n,r)}function S(n,e){var t=b(n,e);Q=0,$("body").enableSelection(),$(H).trigger("action-end",[{mousepos:t}]),$.isFunction(se[ce].onMouseUp)&&se[ce].onMouseUp(n,t)}function I(n,e){var t=b(n,e);$(H).trigger("click",[{mousepos:t}]),$.isFunction(se[ce].onClick)&&se[ce].onClick(n,t)}function P(n,e){if(Q){var t=b(n,e);$.isFunction(se[ce].onMove)&&se[ce].onMove(n,t)}return!0}function M(n){var e=n.originalEvent.detail||-n.originalEvent.wheelDelta;n.preventDefault(),e>0?B():x(),O()}function F(n,e){(ne.paths[n].width!==ne.paths[e].width||ne.paths[n].height!==ne.paths[e].height)&&s()}function B(n){var e=J.get(0).getContext("2d"),t=ne.currentImg,o="";if(t===ne.length-1){if("loop"!==n)return!1;t=0}else t+=1;if(o=ne.paths[t],m(o)&&!p(o))return console.log("image "+t+" not loaded"),ne.currentImg=t,!1;if(!m(o))return!1;if(!p(o))return console.error("Unknown error"),console.debug(o),!1;var r=ne.currentImg;ne.currentImg=t,F(r,t),e.drawImage(ne.paths[t],0,0,K.width,K.height),q(t,ne.length)}function x(n){var e=J.get(0).getContext("2d"),t=ne.currentImg,o="";if(0===t){if("loop"!==n)return;t=ne.length-1}else t-=1;if(o=ne.paths[t],"undefined"!=typeof o.src&&!p(o))return console.log("image "+t+" not loaded"),ne.currentImg=t,!1;var r=ne.currentImg;ne.currentImg=t,F(r,t),e.drawImage(ne.paths[t],0,0,K.width,K.height),q(t,ne.length)}function z(n){var e=ne.paths[n],t=J.get(0).getContext("2d");return p(e)?(F(ne.currentImg,n),ne.currentImg=n,t.drawImage(ne.paths[n],0,0,K.width,K.height),q(ne.currentImg,ne.length),!0):(-1!==ne.finished.indexOf(n)?console.error("Image "+e+" not loaded correctly."):ie&&!ae&&y(n),!1)}function E(){B("loop");var n=1e3*_.playSpeed/ne.length;G=setTimeout(E,n.toFixed(2))}function T(n){return 0===R?($(n).find("i").addClass("icon-stop").removeClass("icon-play"),R=1,E()):G&&($(n).find("i").addClass("icon-play").removeClass("icon-stop"),clearTimeout(G),R=0),R}function q(n,e){var t=(n+1)/e,o=ee.find(".progressBar").width(),r=o*t;ee.find(".progressFill").css("width",r),ee.find(".progressLabel").html(n+1+"/"+e)}function N(n){_.playSpeed=n}function D(){return ne}function L(n,e){_[n]=e}function O(){j.draw(ne.currentImg,A())}function V(){j.clearAnnotations(ne.currentImg),k()}var j,H={},Q=0,R=0,U=0,W=0,X=5,Y=40,G=!1,_={maxPlaySpeed:1,minPlaySpeed:10,playSpeed:5,folderPath:!1,ns:"stackview",controlsContainer:".controls",scrollByPos:!0,activeControl:"scroll"},J=!1,K={progBarH:0},Z=!1,ne={},ee={},te=0,oe=0,re={},ie=!1,ae=!1,ce="scroll",se={};return se={markPoint:{onClick:function(n,e){return"CANVAS"!==n.target.nodeName?!1:(j.addAnnotation(ne.currentImg,"point",e.image),O(),$(H).trigger("mark-point"),void 0)}},markArrow:{imageAnchor:[0,0],canvasAnchor:[0,0],onMove:function(n,e){return"CANVAS"!==n.target.nodeName?!1:(k(),O(),j.markArrow(this.canvasAnchor,e.canvas),void 0)},onMouseDown:function(n,e){return"CANVAS"!==n.target.nodeName?!1:(this.canvasAnchor=e.canvas,this.imageAnchor=e.image,void 0)},onMouseUp:function(n,e){return"CANVAS"!==n.target.nodeName?!1:(j.addAnnotation(ne.currentImg,"arrow",{from:this.imageAnchor,to:e.image}),$(H).trigger("mark-arrow"),void 0)}},scroll:{onMove:function(n,e){var t=e.container[0],o=e.container[1];if(_.scrollByPos){var r=ee.height()-K.progBarH,i=o-K.progBarH,a=Math.floor(i/r*ne.length);ne.paths[a]&&z(a)}else Math.abs(W-o)>X&&(o>W&&B(),W>o&&x(),U=t,W=o);O()}},zoom:{onMove:function(n,e){var t=.05,o=K.height,r=K.width,i=K.height/K.width,a=e.container[0],c=e.container[1];Math.abs(W-c)>5&&(c>W?o-=o*t:W>c&&(o+=o*t),r=o/i,r>50&&o>50&&g({width:r,height:o}),U=a,W=c,O())}},pan:{onMove:function(n,e){h({x:e.container[0],y:e.container[1]},!0),U=e.container[0],W=e.container[1],O()}}},H.render=t,H.setSpeed=N,H.getImageList=D,H.setOption=L,H.unMount=e,H.setCanvasSize=d,H.resetCanvas=i,H.fitViewer=a,H.getAnnotations=function(){return j.getAnnotations()},H.clearAnnotations=V,H.loadAnnotations=function(n){return j.loadAnnotations(n)},H.addHook=function(n,e){j.hooks[n]&&$.isFunction(e)?j.hooks[n]=e:console.error("not a valid hook or passed function")},H};